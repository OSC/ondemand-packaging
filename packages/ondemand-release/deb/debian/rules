#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
export DH_VERBOSE = 1
export CODENAME = $(shell lsb_release -sc 2>/dev/null)
export WEB_DESTDIR = $(CURDIR)/debian/ondemand-release-web
export DEB_BUILD_OPTIONS=nocheck
export VERSION_MAJOR = $(shell echo "$(VERSION)" | cut -d'.' -f1)
export VERSION_MINOR = $(shell echo "$(VERSION)" | cut -d'.' -f2)
export REPO = $(VERSION_MAJOR).$(VERSION_MINOR)
export NODEREPO=node_18.x

%:
	dh $@

override_dh_auto_configure:
	# Do nothing

override_dh_auto_build:
	# Do nothing

override_dh_auto_install:
	mkdir -p $(WEB_DESTDIR)/etc/apt/sources.list.d
	mkdir -p $(WEB_DESTDIR)/etc/apt/trusted.gpg.d
	echo "deb https://apt.osc.edu/ondemand/$(REPO)/web/apt $(CODENAME) main" > $(WEB_DESTDIR)/etc/apt/sources.list.d/ondemand-web.list
	install -m 644 -D $(CURDIR)/ondemand.gpg $(WEB_DESTDIR)/etc/apt/trusted.gpg.d/ondemand-web.gpg
# Debian 12 (bookworm) and Ubuntu 24.04 (noble)
# have NodeJS 18 in OS repos
ifeq ($(CODENAME),bookworm)
else ifeq ($(CODENAME),noble)
else
	echo "deb https://deb.nodesource.com/$(NODEREPO) nodistro main" > $(WEB_DESTDIR)/etc/apt/sources.list.d/nodesource.list
	curl -s https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor > $(WEB_DESTDIR)/etc/apt/trusted.gpg.d/nodesource.gpg
endif

override_dh_builddeb:
	dh_builddeb -- -Zgzip